QIN_end_russian_concession = {
	clr_country_flag = qing_russian_concession
	add_to_variable = { unequal_treaties_consumer_goods = -0.1 }
	add_to_variable = { unequal_treaties_research_speed = 0.04 }
	add_to_variable = { unequal_treaties_resources_to_market = -0.01 }
	add_to_variable = { unequal_treaties_infrastructure = 0.03 }
	add_to_variable = { unequal_treaties_military_factory = 0.07 }
	add_to_variable = { unequal_treaties_civilian_factory = 0.07 }
	add_to_variable = { unequal_treaties_dockyard = 0.07 }
	if = {
		limit = {
			NOT = {
				has_country_flag = qing_german_concession
				has_country_flag = qing_french_concession
				has_country_flag = qing_british_concession
				has_country_flag = qing_japanese_concession
				has_country_flag = qing_american_concession
				has_country_flag = qing_italian_concession
				has_country_flag = qing_austrian_concession
			}
		}
		hidden_effect = {
			swap_ideas = {
				remove_idea = unequal_treaties
				add_idea = free_trade
			}
			remove_dynamic_modifier = { modifier = unequal_treaties_dm }
		}
		custom_effect_tooltip = QIN_swap_unequal_treaties
	}
	else = {
		custom_effect_tooltip = QIN_modify_unequal_treaties
	}
	custom_effect_tooltip = QIN_end_russian_concession_tt
}

QIN_end_german_concession = {
	clr_country_flag = qing_german_concession
	add_to_variable = { unequal_treaties_consumer_goods = -0.07 }
	add_to_variable = { unequal_treaties_research_speed = 0.03 }
	add_to_variable = { unequal_treaties_resources_to_market = -0.01 }
	add_to_variable = { unequal_treaties_infrastructure = 0.02 }
	add_to_variable = { unequal_treaties_military_factory = 0.05 }
	add_to_variable = { unequal_treaties_civilian_factory = 0.05 }
	add_to_variable = { unequal_treaties_dockyard = 0.05 }
	if = {
		limit = {
			NOT = {
				has_country_flag = qing_russian_concession
				has_country_flag = qing_french_concession
				has_country_flag = qing_british_concession
				has_country_flag = qing_japanese_concession
				has_country_flag = qing_american_concession
				has_country_flag = qing_italian_concession
				has_country_flag = qing_austrian_concession
			}
		}
		hidden_effect = {
			swap_ideas = {
				remove_idea = unequal_treaties
				add_idea = free_trade
			}
			remove_dynamic_modifier = { modifier = unequal_treaties_dm }
		}
		custom_effect_tooltip = QIN_swap_unequal_treaties
	}
	else = {
		custom_effect_tooltip = QIN_modify_unequal_treaties
	}
	custom_effect_tooltip = QIN_end_german_concession_tt
}

QIN_end_french_concession = {
	clr_country_flag = qing_french_concession
	add_to_variable = { unequal_treaties_consumer_goods = -0.05 }
	add_to_variable = { unequal_treaties_research_speed = 0.02 }
	add_to_variable = { unequal_treaties_resources_to_market = -0.01 }
	add_to_variable = { unequal_treaties_infrastructure = 0.02 }
	add_to_variable = { unequal_treaties_military_factory = 0.04 }
	add_to_variable = { unequal_treaties_civilian_factory = 0.04 }
	add_to_variable = { unequal_treaties_dockyard = 0.04 }
	if = {
		limit = {
			NOT = {
				has_country_flag = qing_russian_concession
				has_country_flag = qing_german_concession
				has_country_flag = qing_british_concession
				has_country_flag = qing_japanese_concession
				has_country_flag = qing_american_concession
				has_country_flag = qing_italian_concession
				has_country_flag = qing_austrian_concession
			}
		}
		hidden_effect = {
			swap_ideas = {
				remove_idea = unequal_treaties
				add_idea = free_trade
			}
			remove_dynamic_modifier = { modifier = unequal_treaties_dm }
		}
		custom_effect_tooltip = QIN_swap_unequal_treaties
	}
	else = {
		custom_effect_tooltip = QIN_modify_unequal_treaties
		custom_effect_tooltip = QIN_end_french_concession_tt
	}
}

QIN_end_british_concession = {
	clr_country_flag = qing_british_concession
	add_to_variable = { unequal_treaties_consumer_goods = -0.04 }
	add_to_variable = { unequal_treaties_research_speed = 0.02 }
	add_to_variable = { unequal_treaties_resources_to_market = -0.01 }
	add_to_variable = { unequal_treaties_infrastructure = 0.01 }
	add_to_variable = { unequal_treaties_military_factory = 0.04 }
	add_to_variable = { unequal_treaties_civilian_factory = 0.04 }
	add_to_variable = { unequal_treaties_dockyard = 0.04 }
	if = {
		limit = {
			NOT = {
				has_country_flag = qing_russian_concession
				has_country_flag = qing_german_concession
				has_country_flag = qing_french_concession
				has_country_flag = qing_japanese_concession
				has_country_flag = qing_american_concession
				has_country_flag = qing_italian_concession
				has_country_flag = qing_austrian_concession
			}
		}
		hidden_effect = {
			swap_ideas = {
				remove_idea = unequal_treaties
				add_idea = free_trade
			}
			remove_dynamic_modifier = { modifier = unequal_treaties_dm }
		}
		custom_effect_tooltip = QIN_swap_unequal_treaties
	}
	else = {
		custom_effect_tooltip = QIN_modify_unequal_treaties
	}
	custom_effect_tooltip = QIN_end_british_concession_tt
}

QIN_end_japanese_concession = {
	clr_country_flag = qing_japanese_concession
	add_to_variable = { unequal_treaties_consumer_goods = -0.03 }
	add_to_variable = { unequal_treaties_research_speed = 0.01 }
	add_to_variable = { unequal_treaties_resources_to_market = -0.01 }
	add_to_variable = { unequal_treaties_infrastructure = 0.01 }
	add_to_variable = { unequal_treaties_military_factory = 0.02 }
	add_to_variable = { unequal_treaties_civilian_factory = 0.01 }
	add_to_variable = { unequal_treaties_dockyard = 0.01 }
	if = {
		limit = {
			NOT = {
				has_country_flag = qing_russian_concession
				has_country_flag = qing_german_concession
				has_country_flag = qing_french_concession
				has_country_flag = qing_british_concession
				has_country_flag = qing_american_concession
				has_country_flag = qing_italian_concession
				has_country_flag = qing_austrian_concession
			}
		}
		hidden_effect = {
			swap_ideas = {
				remove_idea = unequal_treaties
				add_idea = free_trade
			}
			remove_dynamic_modifier = { modifier = unequal_treaties_dm }
		}
		custom_effect_tooltip = QIN_swap_unequal_treaties
	}
	else = {
		custom_effect_tooltip = QIN_modify_unequal_treaties
	}
	custom_effect_tooltip = QIN_end_japanese_concession_tt
}

QIN_end_american_concession = {
	clr_country_flag = qing_american_concession
	add_to_variable = { unequal_treaties_consumer_goods = -0.03 }
	add_to_variable = { unequal_treaties_research_speed = 0.01 }
	add_to_variable = { unequal_treaties_resources_to_market = -0.01 }
	add_to_variable = { unequal_treaties_infrastructure = 0.01 }
	add_to_variable = { unequal_treaties_military_factory = 0.01 }
	add_to_variable = { unequal_treaties_civilian_factory = 0.02 }
	add_to_variable = { unequal_treaties_dockyard = 0.01 }
	if = {
		limit = {
			NOT = {
				has_country_flag = qing_russian_concession
				has_country_flag = qing_german_concession
				has_country_flag = qing_french_concession
				has_country_flag = qing_british_concession
				has_country_flag = qing_japanese_concession
				has_country_flag = qing_italian_concession
				has_country_flag = qing_austrian_concession
			}
		}
		hidden_effect = {
			swap_ideas = {
				remove_idea = unequal_treaties
				add_idea = free_trade
			}
			remove_dynamic_modifier = { modifier = unequal_treaties_dm }
		}
		custom_effect_tooltip = QIN_swap_unequal_treaties
	}
	else = {
		custom_effect_tooltip = QIN_modify_unequal_treaties
	}
	custom_effect_tooltip = QIN_end_american_concession_tt
}

QIN_end_italian_concession = {
	clr_country_flag = qing_italian_concession
	add_to_variable = { unequal_treaties_consumer_goods = -0.03 }
	add_to_variable = { unequal_treaties_research_speed = 0.01 }
	add_to_variable = { unequal_treaties_resources_to_market = -0.01 }
	add_to_variable = { unequal_treaties_infrastructure = 0.01 }
	add_to_variable = { unequal_treaties_military_factory = 0.01 }
	add_to_variable = { unequal_treaties_civilian_factory = 0.01 }
	add_to_variable = { unequal_treaties_dockyard = 0.02 }
	if = {
		limit = {
			NOT = {
				has_country_flag = qing_russian_concession
				has_country_flag = qing_german_concession
				has_country_flag = qing_french_concession
				has_country_flag = qing_british_concession
				has_country_flag = qing_japanese_concession
				has_country_flag = qing_american_concession
				has_country_flag = qing_austrian_concession
			}
		}
		hidden_effect = {
			swap_ideas = {
				remove_idea = unequal_treaties
				add_idea = free_trade
			}
			remove_dynamic_modifier = { modifier = unequal_treaties_dm }
		}
		custom_effect_tooltip = QIN_swap_unequal_treaties
	}
	else = {
		custom_effect_tooltip = QIN_modify_unequal_treaties
	}
	custom_effect_tooltip = QIN_end_italian_concession_tt
}

QIN_end_austrian_concession = {
	clr_country_flag = qing_austrian_concession
	add_to_variable = { unequal_treaties_consumer_goods = -0.03 }
	add_to_variable = { unequal_treaties_research_speed = 0.01 }
	add_to_variable = { unequal_treaties_resources_to_market = -0.01 }
	add_to_variable = { unequal_treaties_infrastructure = 0.01 }
	add_to_variable = { unequal_treaties_military_factory = 0.01 }
	add_to_variable = { unequal_treaties_civilian_factory = 0.01 }
	add_to_variable = { unequal_treaties_dockyard = 0.01 }
	if = {
		limit = {
			NOT = {
				has_country_flag = qing_russian_concession
				has_country_flag = qing_german_concession
				has_country_flag = qing_french_concession
				has_country_flag = qing_british_concession
				has_country_flag = qing_japanese_concession
				has_country_flag = qing_american_concession
				has_country_flag = qing_italian_concession
			}
		}
		hidden_effect = {
			swap_ideas = {
				remove_idea = unequal_treaties
				add_idea = free_trade
			}
			remove_dynamic_modifier = { modifier = unequal_treaties_dm }
		}
		custom_effect_tooltip = QIN_swap_unequal_treaties
	}
	else = {
		custom_effect_tooltip = QIN_modify_unequal_treaties
	}
	custom_effect_tooltip = QIN_end_austrian_concession_tt
}

QIN_recalculate_loyalties = {
	QIN_military_loyalty_calculation = yes
	QIN_royalists_loyalty_calculation = yes
	QIN_reformists_loyalty_calculation = yes
	QIN_gentry_loyalty_calculation = yes
}

QIN_military_loyalty_calculation = {
	clamp_variable = {
		var = QIN_military_loyalty
		min = 0
		max = 100
	}
	clamp_variable = {
		var = QIN_military_popularity
		min = 0
		max = 100
	}
	#if less than 50, the loyalty calculation is different
	if = {
		limit = {
			check_variable = {
				QIN_military_loyalty < 51
			}
		}
		set_variable = {
			QIN_military_effect = 50
		}
		subtract_from_variable = {
			var = QIN_military_effect
			value = QIN_military_loyalty
		}
		else = {
			set_variable = {
				QIN_military_effect = QIN_military_loyalty #positive calculation
			}
			subtract_from_variable = {
				var = QIN_military_effect
				value = 50
			}
		}
	}
	set_variable = {
		QIN_military_effect_popularity = QIN_military_popularity
	}
	divide_variable = {
		QIN_military_effect_popularity = 25000
	}
	multiply_variable = {
		QIN_military_effect = QIN_military_effect_popularity
	}
	#turning the calculation into a direct malus if less than 50
	if = {
		limit = {
			check_variable = {
				QIN_military_loyalty < 51
			}
		}
		multiply_variable = {
			QIN_military_effect = -1
		}
	}
	#we are calculing alt-variables for half value and negative values (for consummer goods = -20% for example)
	set_variable = {
		QIN_military_effect_half = QIN_military_effect
	}
	divide_variable = {
		QIN_military_effect_half = 2
	}
	set_variable = {
		QIN_military_effect_double = QIN_military_effect
	}
	multiply_variable = {
		QIN_military_effect_double = 2
	}
	set_variable = {
		QIN_military_reversed_effect = QIN_military_effect
	}
	multiply_variable = {
		QIN_military_reversed_effect = -1
	}
}

QIN_royalists_loyalty_calculation = {
	clamp_variable = {
		var = QIN_royalists_loyalty
		min = 0
		max = 100
	}
	clamp_variable = {
		var = QIN_royalists_popularity
		min = 0
		max = 100
	}
	#if less than 50, the loyalty calculation is different
	if = {
		limit = {
			check_variable = {
				QIN_royalists_loyalty < 51
			}
		}
		set_variable = {
			QIN_royalists_effect = 50
		}
		subtract_from_variable = {
			var = QIN_royalists_effect
			value = QIN_royalists_loyalty
		}
		else = {
			set_variable = {
				QIN_royalists_effect = QIN_royalists_loyalty #positive calculation
			}
			subtract_from_variable = {
				var = QIN_royalists_effect
				value = 50
			}
		}
	}
	set_variable = {
		QIN_royalists_effect_popularity = QIN_royalists_popularity
	}
	divide_variable = {
		QIN_royalists_effect_popularity = 25000
	}
	multiply_variable = {
		QIN_royalists_effect = QIN_royalists_effect_popularity
	}
	#turning the calculation into a direct malus if less than 50
	if = {
		limit = {
			check_variable = {
				QIN_royalists_loyalty < 51
			}
		}
		multiply_variable = {
			QIN_royalists_effect = -1
		}
	}
	#we are calculing alt-variables for half value and negative values (for consummer goods = -20% for example)
	set_variable = {
		QIN_royalists_effect_half = QIN_royalists_effect
	}
	divide_variable = {
		QIN_royalists_effect_half = 2
	}
	set_variable = {
		QIN_royalists_effect_double = QIN_royalists_effect
	}
	multiply_variable = {
		QIN_royalists_effect_double = 2
	}
	set_variable = {
		QIN_royalists_reversed_effect = QIN_royalists_effect
	}
	multiply_variable = {
		QIN_royalists_reversed_effect = -1
	}
}

QIN_reformists_loyalty_calculation = {
	clamp_variable = {
		var = QIN_reformists_loyalty
		min = 0
		max = 100
	}
	clamp_variable = {
		var = QIN_reformists_popularity
		min = 0
		max = 100
	}
	#if less than 50, the loyalty calculation is different
	if = {
		limit = {
			check_variable = {
				QIN_reformists_loyalty < 51
			}
		}
		set_variable = {
			QIN_reformists_effect = 50
		}
		subtract_from_variable = {
			var = QIN_reformists_effect
			value = QIN_reformists_loyalty
		}
		else = {
			set_variable = {
				QIN_reformists_effect = QIN_reformists_loyalty #positive calculation
			}
			subtract_from_variable = {
				var = QIN_reformists_effect
				value = 50
			}
		}
	}
	set_variable = {
		QIN_reformists_effect_popularity = QIN_reformists_popularity
	}
	divide_variable = {
		QIN_reformists_effect_popularity = 25000
	}
	multiply_variable = {
		QIN_reformists_effect = QIN_reformists_effect_popularity
	}
	#turning the calculation into a direct malus if less than 50
	if = {
		limit = {
			check_variable = {
				QIN_reformists_loyalty < 51
			}
		}
		multiply_variable = {
			QIN_reformists_effect = -1
		}
	}
	#we are calculing alt-variables for half value and negative values (for consummer goods = -20% for example)
	set_variable = {
		QIN_reformists_effect_half = QIN_reformists_effect
	}
	divide_variable = {
		QIN_reformists_effect_half = 2
	}
	set_variable = {
		QIN_reformists_effect_double = QIN_reformists_effect
	}
	multiply_variable = {
		QIN_reformists_effect_double = 2
	}
	set_variable = {
		QIN_reformists_reversed_effect = QIN_reformists_effect
	}
	multiply_variable = {
		QIN_reformists_reversed_effect = -1
	}
}

QIN_gentry_loyalty_calculation = {
	clamp_variable = {
		var = QIN_gentry_loyalty
		min = 0
		max = 100
	}
	clamp_variable = {
		var = QIN_gentry_popularity
		min = 0
		max = 100
	}
	#if less than 50, the loyalty calculation is different
	if = {
		limit = {
			check_variable = {
				QIN_gentry_loyalty < 51
			}
		}
		set_variable = {
			QIN_gentry_effect = 50
		}
		subtract_from_variable = {
			var = QIN_gentry_effect
			value = QIN_gentry_loyalty
		}
		else = {
			set_variable = {
				QIN_gentry_effect = QIN_gentry_loyalty #positive calculation
			}
			subtract_from_variable = {
				var = QIN_gentry_effect
				value = 50
			}
		}
	}
	set_variable = {
		QIN_gentry_effect_popularity = QIN_gentry_popularity
	}
	divide_variable = {
		QIN_gentry_effect_popularity = 25000
	}
	multiply_variable = {
		QIN_gentry_effect = QIN_gentry_effect_popularity
	}
	#turning the calculation into a direct malus if less than 50
	if = {
		limit = {
			check_variable = {
				QIN_gentry_loyalty < 51
			}
		}
		multiply_variable = {
			QIN_gentry_effect = -1
		}
	}
	#we are calculing alt-variables for half value and negative values (for consummer goods = -20% for example)
	set_variable = {
		QIN_gentry_effect_half = QIN_gentry_effect
	}
	divide_variable = {
		QIN_gentry_effect_half = 2
	}
	set_variable = {
		QIN_gentry_effect_double = QIN_gentry_effect
	}
	multiply_variable = {
		QIN_gentry_effect_double = 2
	}
	set_variable = {
		QIN_gentry_reversed_effect = QIN_gentry_effect
	}
	multiply_variable = {
		QIN_gentry_reversed_effect = -1
	}
}

QIN_improve_industrialization = {
	if = {
		limit = {
			has_idea = QIN_idea_weak_industry
		}
		swap_ideas = {
			remove_idea = QIN_idea_weak_industry
			add_idea = QIN_idea_weak_industry2
		}
	}
	if = {
		limit = {
			has_idea = QIN_idea_weak_industry2
		}
		swap_ideas = {
			remove_idea = QIN_idea_weak_industry2
			add_idea = QIN_idea_weak_industry3
		}
	}
	if = {
		limit = {
			has_idea = QIN_idea_weak_industry3
		}
		swap_ideas = {
			remove_idea = QIN_idea_weak_industry3
			add_idea = QIN_idea_weak_industry4
		}
	}
	if = {
		limit = {
			has_idea = QIN_idea_weak_industry4
		}
		swap_ideas = {
			remove_idea = QIN_idea_weak_industry4
			add_idea = QIN_idea_weak_industry5
		}
	}
	if = {
		limit = {
			has_idea = QIN_idea_weak_industry5
		}
		swap_ideas = {
			remove_idea = QIN_idea_weak_industry5
			add_idea = QIN_idea_weak_industry6
		}
	}
}